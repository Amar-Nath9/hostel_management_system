{% load static %}
<!doctype html>
<html lang="en">
<head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <title>{{ request.user.first_name }}</title>
    <link rel="icon" href="{% static 'logotitle.png' %}" type="image/icon type">
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet" integrity="sha384-QWTKZyjpPEjISv5WaRU9OFeRpok6YctnYmDr5pNlyT2bRjXh0JMhjY6hW+ALEwIH" crossorigin="anonymous">
    <style>
      /* Center the alert at the top */
      .alert-center {
          position: absolute;
          top: 20px; /* Position from the top */
          left: 50%; /* Center horizontally */
          transform: translateX(-50%); /* Adjust for element width */
          z-index: 1050;
          min-width: 300px;
          width: auto; /* Allows for automatic width adjustment */
      }
    </style>
</head>
<body>
    {% if messages %}
    <div class="alert alert-dismissible fade show alert-center" role="alert">
        {% for message in messages %}
            <div class="alert alert-{{ message.tags }}">
                {{ message }}
            </div>
        {% endfor %}
        <button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="Close"></button>
    </div>
    {% endif %}
    
    <section style="background-color: #eee;">
        <div class="container py-5">
            <div class="row">
                <div class="col">
                    <nav aria-label="breadcrumb" class="bg-body-tertiary rounded-3 p-3 mb-4 d-flex justify-content-between align-items-center">
                        <ol class="breadcrumb mb-0">
                            <li class="breadcrumb-item active" aria-current="page">User Profile</li>
                        </ol>
                        <a href="{% url 'logout' %}" class="btn btn-primary" role="button">Logout</a>
                    </nav>
                </div>
            </div>
            
            <div class="row">
                <!-- Profile Section -->
                <div class="col-lg-4">
                    <div class="card mb-4">
                        <div class="card-body text-center">
                            {% if request.user.user_details.profile_pic %}
                                <img src="{{ request.user.user_details.profile_pic.url }}" alt="avatar"
                                     class="rounded-circle img-fluid" style="width: 150px;">
                            {% else %}
                                <img src="https://mdbcdn.b-cdn.net/img/Photos/new-templates/bootstrap-chat/ava3.webp" alt="avatar"
                                     class="rounded-circle img-fluid" style="width: 150px;">
                            {% endif %}
                            <h5 class="my-3">{{ request.user.first_name }}</h5>
                            <div class="d-flex justify-content-center mb-2">
                                <!-- Button to trigger the modal -->
                                <button type="button" class="btn btn-outline-primary" data-bs-toggle="modal" data-bs-target="#editProfileModal">
                                    Edit Profile
                                </button>
                            </div>
                        </div>
                    </div>
                </div>
                
                <!-- User Details and Payment Section -->
                <div class="col-lg-8">
                    <div class="card mb-4">
                        <div class="card-body">
                            <!-- Existing User Details Section -->
                            <div class="row">
                                <div class="col-sm-3"><p class="mb-0">Full Name</p></div>
                                <div class="col-sm-9"><p class="text-muted mb-0">{{ request.user.first_name }}</p></div>
                            </div>
                            <hr>
                            <div class="row">
                                <div class="col-sm-3"><p class="mb-0">Email</p></div>
                                <div class="col-sm-9"><p class="text-muted mb-0">{{ request.user.email }}</p></div>
                            </div>
                            <hr>
                            <div class="row">
                                <div class="col-sm-3"><p class="mb-0">Phone</p></div>
                                <div class="col-sm-9"><p class="text-muted mb-0">{{ request.user.user_details.mobile_no }}</p></div>
                            </div>
                            <hr>
                            <div class="row">
                                <div class="col-sm-3"><p class="mb-0">Service Type</p></div>
                                <div class="col-sm-9">
                                    <p class="text-muted mb-0">
                                        {% if request.user.user_details.service_type == 'AF' %}
                                            Accommodation & Food
                                        {% elif request.user.user_details.service_type == 'FO' %}
                                            Food Only
                                        {% endif %}
                                    </p>
                                </div>
                            </div>
                            <hr>
                            <div class="row">
                                <div class="col-sm-3"><p class="mb-0">Total Amount Paid (This Month)</p></div>
                                <div class="col-sm-9"><p class="text-muted mb-0">{{ total_paid }}</p></div>
                            </div>
                            <hr>
                            <div class="row">
                                <div class="col-sm-3"><p class="mb-0">Remaining Balance (This Month)</p></div>
                                <div class="col-sm-9"><p class="text-muted mb-0">{{ remaining_balance }}</p></div>
                            </div>
                            
                        </div>
                    </div>
                    
                   <!-- Current Month Payment History and Form -->
                   <div class="card mb-4">
                        <div class="card-body">
                            <h5 class="mb-3">Current Month Payment History</h5>
                            <ul class="list-group mb-3">
                                {% for payment in payments %}
                                    <li class="list-group-item d-flex justify-content-between align-items-center">
                                        {{ payment.payment_date|date:"F Y" }} - Amount: {{ payment.amount_paid }}
                                        {% if payment.amount_paid >= request.user.user_details.remaining_balance %}
                                            <span class="badge bg-success rounded-pill">Completed ✅</span>
                                        {% else %}
                                            <span class="badge bg-warning rounded-pill">Partial ❌</span>
                                        {% endif %}
                                    </li>
                                {% endfor %}
                            </ul>
    
                            <!-- Payment Form -->
                            <h5 class="mb-3">Make a Payment</h5>
                            <form method="POST" action="{% url 'upload_payment' %}" enctype="multipart/form-data">
                                {% csrf_token %}
                                <div class="mb-3">
                                    <label for="amount_paid" class="form-label">Amount to Pay</label>
                                    <input type="number" class="form-control" id="amount_paid" name="amount_paid" required>
                                </div>
                                <div class="mb-3">
                                    <label for="payment_date" class="form-label">Payment Date</label>
                                    <input type="date" class="form-control" id="payment_date" name="payment_date" required>
                                </div>
                                <div class="mb-3">
                                    <label for="payment_screenshot" class="form-label">Payment Screenshot</label>
                                    <input type="file" class="form-control" id="payment_screenshot" name="payment_screenshot" required>
                                </div>
                                <button type="submit" class="btn btn-primary">Submit Payment</button>
                            </form>
                        </div>
                    </div>

                    <!-- Full Payment History Section -->
                    <div class="card mb-4">
                        <div class="card-body">
                            <h5 class="mb-3">All Payment History</h5>
                            <ul class="list-group mb-3">
                                {% for payment in all_payments %}
                                    <li class="list-group-item d-flex justify-content-between align-items-center">
                                        {{ payment.payment_date|date:"F Y" }} - Amount: {{ payment.amount_paid }}
                                        {% if payment.is_approved %}
                                            <span class="badge bg-success rounded-pill">Approved ✅</span>
                                        {% else %}
                                            <span class="badge bg-warning rounded-pill">Pending ❌</span>
                                        {% endif %}
                                    </li>
                                {% empty %}
                                    <li class="list-group-item">No payment history available.</li>
                                {% endfor %}
                            </ul>
                        </div>
                    </div>

                </div>
            </div>
        </div>
    </section>

    <!-- Modal for Editing Profile -->
    <div class="modal fade" id="editProfileModal" tabindex="-1" aria-labelledby="editProfileModalLabel" aria-hidden="true">
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title" id="editProfileModalLabel">Edit Profile</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <div class="modal-body">
                    <form method="POST" action="{% url 'update_profile' %}" enctype="multipart/form-data">
                        {% csrf_token %}
                        <div class="mb-3">
                            <label for="name" class="form-label">Name</label>
                            <input type="text" class="form-control" id="name" name="name" value="{{ request.user.first_name }}" required>
                        </div>
                        <div class="mb-3">
                            <label for="aadhaar_num" class="form-label">Aadhaar Number</label>
                            <input type="text" class="form-control" id="aadhaar_num" name="aadhaar_num" value="{{ request.user.user_details.aadhaar_num }}" maxlength="12" minlength="12" pattern="\d{12}" required>
                        </div>
                        <div class="mb-3">
                            <label for="collage_name" class="form-label">College Name</label>
                            <input type="text" class="form-control" id="collage_name" name="collage_name" value="{{ request.user.user_details.collage_name }}">
                        </div>
                        <div class="mb-3">
                            <label for="profile_pic" class="form-label">Profile Picture</label>
                            <input type="file" class="form-control" id="profile_pic" name="profile_pic">
                        </div>
                        <div class="mb-3">
                            <label for="aadhaar_image" class="form-label">Aadhaar File</label>
                            <input type="file" class="form-control" id="aadhaar_image" name="aadhaar_image">
                        </div>
                        <div class="modal-footer">
                            <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
                            <button type="submit" class="btn btn-primary">Save changes</button>
                        </div>
                    </form>
                </div>
            </div>
        </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js" integrity="sha384-YvpcrYf0tY3lHB60NNkmXc5s9fDVZLESaAA55NDzOxhy9GkcIdslK1eN7N6jIeHz" crossorigin="anonymous"></script>
    <script>
        setTimeout(function() {
            var alert = document.querySelector('.alert');
            if (alert) {
                alert.style.display = 'none';
            }
        }, 4000); // Close after 5 seconds
    </script>
</body>
</html>
